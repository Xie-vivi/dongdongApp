<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xystapp.mapper.AdminRoleMapper">

    <!-- 分配角色给管理员 -->
    <insert id="assignRole">
        INSERT INTO admin_roles (admin_id, role_id, assigned_by, assigned_at, is_active)
        VALUES (#{adminId}, #{roleId}, #{assignedBy}, NOW(), 1)
        ON DUPLICATE KEY UPDATE
            assigned_by = #{assignedBy},
            assigned_at = NOW(),
            is_active = 1
    </insert>

    <!-- 批量分配角色给管理员 -->
    <insert id="batchAssignRoles">
        INSERT INTO admin_roles (admin_id, role_id, assigned_by, assigned_at, is_active)
        VALUES
        <foreach collection="roleIds" item="roleId" separator=",">
            (#{adminId}, #{roleId}, #{assignedBy}, NOW(), 1)
        </foreach>
        ON DUPLICATE KEY UPDATE
            assigned_by = #{assignedBy},
            assigned_at = NOW(),
            is_active = 1
    </insert>

    <!-- 移除管理员的角色 -->
    <delete id="removeRole">
        DELETE FROM admin_roles 
        WHERE admin_id = #{adminId} AND role_id = #{roleId}
    </delete>

    <!-- 批量移除管理员的角色 -->
    <delete id="batchRemoveRoles">
        DELETE FROM admin_roles 
        WHERE admin_id = #{adminId} AND role_id IN
        <foreach collection="roleIds" item="roleId" open="(" separator="," close=")">
            #{roleId}
        </foreach>
    </delete>

    <!-- 移除管理员的所有角色 -->
    <delete id="removeAllRoles">
        DELETE FROM admin_roles WHERE admin_id = #{adminId}
    </delete>

    <!-- 获取管理员的角色ID列表 -->
    <select id="getAdminRoleIds" resultType="long">
        SELECT role_id 
        FROM admin_roles 
        WHERE admin_id = #{adminId} AND is_active = 1
        AND (expires_at IS NULL OR expires_at > NOW())
        ORDER BY assigned_at DESC
    </select>

    <!-- 获取角色的管理员ID列表 -->
    <select id="getRoleAdminIds" resultType="long">
        SELECT admin_id 
        FROM admin_roles 
        WHERE role_id = #{roleId} AND is_active = 1
        AND (expires_at IS NULL OR expires_at > NOW())
        ORDER BY assigned_at DESC
    </select>

    <!-- 检查管理员是否拥有指定角色 -->
    <select id="hasRole" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM admin_roles 
        WHERE admin_id = #{adminId} AND role_id = #{roleId} 
        AND is_active = 1
        AND (expires_at IS NULL OR expires_at > NOW())
    </select>

    <!-- 统计角色下的管理员数量 -->
    <select id="countAdminsByRole" resultType="integer">
        SELECT COUNT(*)
        FROM admin_roles 
        WHERE role_id = #{roleId} AND is_active = 1
        AND (expires_at IS NULL OR expires_at > NOW())
    </select>

    <!-- 更新角色关联状态 -->
    <update id="updateRoleStatus">
        UPDATE admin_roles 
        SET is_active = #{isActive}, updated_at = NOW()
        WHERE admin_id = #{adminId} AND role_id = #{roleId}
    </update>

    <!-- 设置角色过期时间 -->
    <update id="setRoleExpiration">
        UPDATE admin_roles 
        SET expires_at = #{expiresAt}, updated_at = NOW()
        WHERE admin_id = #{adminId} AND role_id = #{roleId}
    </update>

    <!-- 清理过期的角色关联 -->
    <delete id="cleanupExpiredRoles">
        DELETE FROM admin_roles 
        WHERE expires_at IS NOT NULL AND expires_at &lt;= NOW()
    </delete>

    <!-- 获取即将过期的角色关联 -->
    <select id="getExpiringRoles" resultType="com.xystapp.mapper.AdminRoleMapper$AdminRoleInfo">
        SELECT 
            ar.admin_id,
            a.username as adminName,
            ar.role_id,
            r.name as roleName,
            ar.assigned_at,
            ar.expires_at,
            oa.username as assignedByName
        FROM admin_roles ar
        INNER JOIN admins a ON ar.admin_id = a.id
        INNER JOIN roles r ON ar.role_id = r.id
        LEFT JOIN admins oa ON ar.assigned_by = oa.id
        WHERE ar.expires_at IS NOT NULL 
        AND ar.expires_at BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL #{days} DAY)
        AND ar.is_active = 1
        ORDER BY ar.expires_at ASC
    </select>

</mapper>
