<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xystapp.mapper.ActivityCommentMapper">

    <!-- 活动评论结果映射（包含用户信息） -->
    <resultMap id="ActivityCommentWithUserInfoMap" type="com.xystapp.entity.ActivityComment">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="activity_id" property="activityId"/>
        <result column="content" property="content"/>
        <result column="at_user_id" property="atUserId"/>
        <result column="reply_to_id" property="replyToId"/>
        <result column="created_at" property="createdAt"/>
        
        <!-- 用户信息 -->
        <result column="username" property="username"/>
        <result column="nickname" property="nickname"/>
        <result column="avatar" property="avatar"/>
        
        <!-- 活动信息 -->
        <result column="activity_title" property="activityTitle"/>
        
        <!-- @用户信息 -->
        <result column="at_username" property="atUsername"/>
        <result column="at_nickname" property="atNickname"/>
        
        <!-- 回复评论信息 -->
        <result column="reply_to_username" property="replyToUsername"/>
        <result column="reply_to_content" property="replyToContent"/>
    </resultMap>

    <!-- 获取活动评论详情（包含用户信息） -->
    <select id="selectCommentWithUserInfo" resultMap="ActivityCommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.activity_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            a.title as activity_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM activity_comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN activities a ON c.activity_id = a.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN activity_comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.id = #{commentId}
    </select>

    <!-- 获取活动评论列表（包含用户信息） -->
    <select id="selectActivityCommentsWithUserInfo" resultMap="ActivityCommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.activity_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            a.title as activity_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM activity_comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN activities a ON c.activity_id = a.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN activity_comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.activity_id = #{activityId} AND c.reply_to_id IS NULL
        ORDER BY c.created_at DESC
    </select>

    <!-- 根据查询条件获取评论列表（包含用户信息） -->
    <select id="selectCommentsWithQuery" resultMap="ActivityCommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.activity_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            a.title as activity_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM activity_comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN activities a ON c.activity_id = a.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN activity_comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        <where>
            <if test="query.postId != null">
                AND c.activity_id = #{query.postId}
            </if>
            <if test="query.userId != null">
                AND c.user_id = #{query.userId}
            </if>
            <if test="query.atUserId != null">
                AND c.at_user_id = #{query.atUserId}
            </if>
            <if test="query.replyToId != null">
                AND c.reply_to_id = #{query.replyToId}
            </if>
            <if test="query.keyword != null and query.keyword != ''">
                AND (c.content LIKE CONCAT('%', #{query.keyword}, '%')
                     OR u.username LIKE CONCAT('%', #{query.keyword}, '%')
                     OR u.nickname LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
        </where>
        <choose>
            <when test="query.sortBy == 'created_at' and query.sortOrder == 'asc'">
                ORDER BY c.created_at ASC
            </when>
            <when test="query.sortBy == 'created_at' and query.sortOrder == 'desc'">
                ORDER BY c.created_at DESC
            </when>
            <otherwise>
                ORDER BY c.created_at DESC
            </otherwise>
        </choose>
    </select>

    <!-- 获取回复评论列表（包含用户信息） -->
    <select id="selectReplyCommentsWithUserInfo" resultMap="ActivityCommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.activity_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            a.title as activity_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM activity_comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN activities a ON c.activity_id = a.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN activity_comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.reply_to_id = #{parentCommentId}
        ORDER BY c.created_at ASC
    </select>

    <!-- 获取用户活动评论列表（包含用户信息和活动信息） -->
    <select id="selectUserCommentsWithUserInfo" resultMap="ActivityCommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.activity_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            a.title as activity_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM activity_comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN activities a ON c.activity_id = a.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN activity_comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.user_id = #{userId}
        ORDER BY c.created_at DESC
    </select>

    <!-- 获取@用户活动评论列表（包含用户信息） -->
    <select id="selectAtUserCommentsWithUserInfo" resultMap="ActivityCommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.activity_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            a.title as activity_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM activity_comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN activities a ON c.activity_id = a.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN activity_comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.at_user_id = #{atUserId}
        ORDER BY c.created_at DESC
    </select>

    <!-- 删除评论及其所有回复（使用存储过程方式，兼容MySQL 5.7+） -->
    <delete id="deleteCommentAndReplies">
        DELETE FROM activity_comments 
        WHERE id = #{commentId}
           OR reply_to_id = #{commentId}
           OR reply_to_id IN (
               SELECT id FROM (
                   SELECT c2.id 
                   FROM activity_comments c1
                   INNER JOIN activity_comments c2 ON c2.reply_to_id = c1.id
                   WHERE c1.id = #{commentId}
                   UNION
                   SELECT c3.id
                   FROM activity_comments c1
                   INNER JOIN activity_comments c2 ON c2.reply_to_id = c1.id
                   INNER JOIN activity_comments c3 ON c3.reply_to_id = c2.id
                   WHERE c1.id = #{commentId}
                   UNION
                   SELECT c4.id
                   FROM activity_comments c1
                   INNER JOIN activity_comments c2 ON c2.reply_to_id = c1.id
                   INNER JOIN activity_comments c3 ON c3.reply_to_id = c2.id
                   INNER JOIN activity_comments c4 ON c4.reply_to_id = c3.id
                   WHERE c1.id = #{commentId}
               ) AS nested_comments
           )
    </delete>

    <!-- 删除活动的所有评论 -->
    <delete id="deleteCommentsByActivityId">
        DELETE FROM activity_comments WHERE activity_id = #{activityId}
    </delete>

    <!-- 检查用户是否存在 -->
    <select id="userExists" resultType="boolean">
        SELECT COUNT(1) > 0 FROM users WHERE id = #{userId}
    </select>

    <!-- 检查用户是否是评论作者 -->
    <select id="isCommentAuthor" resultType="boolean">
        SELECT COUNT(1) > 0 
        FROM activity_comments 
        WHERE id = #{commentId} AND user_id = #{userId}
    </select>

    <!-- 获取回复深度（兼容MySQL 5.7+） -->
    <select id="getReplyDepth" resultType="integer">
        SELECT CASE 
            WHEN c1.reply_to_id IS NULL THEN 0
            WHEN c2.reply_to_id IS NULL THEN 1
            WHEN c3.reply_to_id IS NULL THEN 2
            WHEN c4.reply_to_id IS NULL THEN 3
            ELSE 4
        END as depth
        FROM activity_comments c1
        LEFT JOIN activity_comments c2 ON c1.reply_to_id = c2.id
        LEFT JOIN activity_comments c3 ON c2.reply_to_id = c3.id
        LEFT JOIN activity_comments c4 ON c3.reply_to_id = c4.id
        WHERE c1.id = #{commentId}
    </select>

    <!-- 获取评论回复数量（兼容MySQL 5.7+） -->
    <select id="getReplyCount" resultType="integer">
        SELECT (
            SELECT COUNT(1) FROM activity_comments WHERE reply_to_id = #{commentId}
        ) + (
            SELECT COUNT(1) 
            FROM activity_comments c1
            INNER JOIN activity_comments c2 ON c1.reply_to_id = c2.id
            WHERE c2.reply_to_id = #{commentId}
        ) + (
            SELECT COUNT(1) 
            FROM activity_comments c1
            INNER JOIN activity_comments c2 ON c1.reply_to_id = c2.id
            INNER JOIN activity_comments c3 ON c2.reply_to_id = c3.id
            WHERE c3.reply_to_id = #{commentId}
        ) + (
            SELECT COUNT(1) 
            FROM activity_comments c1
            INNER JOIN activity_comments c2 ON c1.reply_to_id = c2.id
            INNER JOIN activity_comments c3 ON c2.reply_to_id = c3.id
            INNER JOIN activity_comments c4 ON c3.reply_to_id = c4.id
            WHERE c4.reply_to_id = #{commentId}
        ) as total_count
    </select>

    <!-- 统计活动评论数量 -->
    <select id="countCommentsByActivityId" resultType="long">
        SELECT COUNT(1) FROM activity_comments WHERE activity_id = #{activityId}
    </select>

    <!-- 统计活动今日评论数量 -->
    <select id="countTodayCommentsByActivityId" resultType="long">
        SELECT COUNT(1) 
        FROM activity_comments 
        WHERE activity_id = #{activityId} 
        AND DATE(created_at) = CURDATE()
    </select>

    <!-- 统计活动回复评论数量 -->
    <select id="countReplyCommentsByActivityId" resultType="long">
        SELECT COUNT(1) 
        FROM activity_comments 
        WHERE activity_id = #{activityId} 
        AND reply_to_id IS NOT NULL
    </select>

    <!-- 获取评论路径（用于计算回复深度） -->
    <select id="getCommentPath" resultType="long">
        SELECT CASE 
            WHEN c1.reply_to_id IS NULL THEN c1.id
            WHEN c2.reply_to_id IS NULL THEN c2.id
            WHEN c3.reply_to_id IS NULL THEN c3.id
            WHEN c4.reply_to_id IS NULL THEN c4.id
            ELSE c1.id
        END as path_id
        FROM activity_comments c1
        LEFT JOIN activity_comments c2 ON c1.reply_to_id = c2.id
        LEFT JOIN activity_comments c3 ON c2.reply_to_id = c3.id
        LEFT JOIN activity_comments c4 ON c3.reply_to_id = c4.id
        WHERE c1.id = #{commentId}
    </select>

</mapper>
