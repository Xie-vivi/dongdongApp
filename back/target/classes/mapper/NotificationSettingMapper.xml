<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xystapp.mapper.NotificationSettingMapper">

    <!-- 通知设置结果映射 -->
    <resultMap id="NotificationSettingMap" type="com.xystapp.entity.NotificationSetting">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="type" property="type"/>
        <result column="enabled" property="enabled"/>
        <result column="push_enabled" property="pushEnabled"/>
        <result column="email_enabled" property="emailEnabled"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 根据用户ID获取通知设置列表 -->
    <select id="selectByUserId" resultMap="NotificationSettingMap">
        SELECT id, user_id, type, enabled, push_enabled, email_enabled, created_at, updated_at
        FROM notification_settings
        WHERE user_id = #{userId}
        ORDER BY type ASC
    </select>

    <!-- 根据用户ID和通知类型获取设置 -->
    <select id="selectByUserIdAndType" resultMap="NotificationSettingMap">
        SELECT id, user_id, type, enabled, push_enabled, email_enabled, created_at, updated_at
        FROM notification_settings
        WHERE user_id = #{userId} AND type = #{type}
        LIMIT 1
    </select>

    <!-- 批量获取通知设置 -->
    <select id="selectByUserIdAndTypes" resultMap="NotificationSettingMap">
        SELECT id, user_id, type, enabled, push_enabled, email_enabled, created_at, updated_at
        FROM notification_settings
        WHERE user_id = #{userId} AND type IN
        <foreach collection="types" item="type" open="(" separator="," close=")">
            #{type}
        </foreach>
        ORDER BY type ASC
    </select>

    <!-- 删除用户的所有通知设置 -->
    <delete id="deleteByUserId">
        DELETE FROM notification_settings WHERE user_id = #{userId}
    </delete>

    <!-- 删除指定的通知设置 -->
    <delete id="deleteByUserIdAndType">
        DELETE FROM notification_settings WHERE user_id = #{userId} AND type = #{type}
    </delete>

    <!-- 更新通知设置 -->
    <update id="updateNotificationSetting">
        UPDATE notification_settings 
        SET 
            enabled = #{enabled},
            push_enabled = #{pushEnabled},
            email_enabled = #{emailEnabled},
            updated_at = NOW()
        WHERE user_id = #{userId} AND type = #{type}
    </update>

    <!-- 批量更新通知设置 -->
    <update id="updateMultipleSettings">
        <foreach collection="settings" item="setting" separator=";">
            UPDATE notification_settings 
            SET 
                enabled = #{setting.enabled},
                push_enabled = #{setting.pushEnabled},
                email_enabled = #{setting.emailEnabled},
                updated_at = NOW()
            WHERE user_id = #{userId} AND type = #{setting.type}
        </foreach>
    </update>

    <!-- 检查通知设置是否存在 -->
    <select id="settingExists" resultType="boolean">
        SELECT COUNT(1) > 0 
        FROM notification_settings 
        WHERE user_id = #{userId} AND type = #{type}
    </select>

    <!-- 获取启用的通知类型 -->
    <select id="selectEnabledTypes" resultType="string">
        SELECT type 
        FROM notification_settings 
        WHERE user_id = #{userId} AND enabled = 1
        ORDER BY type ASC
    </select>

    <!-- 获取启用推送的通知类型 -->
    <select id="selectPushEnabledTypes" resultType="string">
        SELECT type 
        FROM notification_settings 
        WHERE user_id = #{userId} AND push_enabled = 1
        ORDER BY type ASC
    </select>

    <!-- 获取启用邮件的通知类型 -->
    <select id="selectEmailEnabledTypes" resultType="string">
        SELECT type 
        FROM notification_settings 
        WHERE user_id = #{userId} AND email_enabled = 1
        ORDER BY type ASC
    </select>

    <!-- 统计用户启用的通知类型数量 -->
    <select id="countEnabledTypes" resultType="integer">
        SELECT COUNT(1) 
        FROM notification_settings 
        WHERE user_id = #{userId} AND enabled = 1
    </select>

    <!-- 创建默认通知设置 -->
    <update id="createDefaultSettings">
        INSERT INTO notification_settings (user_id, type, enabled, push_enabled, email_enabled, created_at, updated_at)
        VALUES 
        (#{userId}, 'like', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'star', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'comment', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'at', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'follow', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'follow_post', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'follow_activity', 1, 1, 0, NOW(), NOW())
    </update>

    <!-- 重置通知设置为默认值 -->
    <update id="resetToDefaults">
        DELETE FROM notification_settings WHERE user_id = #{userId};
        INSERT INTO notification_settings (user_id, type, enabled, push_enabled, email_enabled, created_at, updated_at)
        VALUES 
        (#{userId}, 'like', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'star', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'comment', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'at', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'follow', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'follow_post', 1, 1, 0, NOW(), NOW()),
        (#{userId}, 'follow_activity', 1, 1, 0, NOW(), NOW())
    </update>

</mapper>
