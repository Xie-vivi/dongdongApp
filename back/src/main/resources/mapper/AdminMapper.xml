<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xystapp.mapper.AdminMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.xystapp.entity.Admin">
        <id column="id" property="id"/>
        <result column="username" property="username"/>
        <result column="password_hash" property="passwordHash"/>
        <result column="email" property="email"/>
        <result column="phone" property="phone"/>
        <result column="real_name" property="realName"/>
        <result column="avatar" property="avatar"/>
        <result column="status" property="status"/>
        <result column="last_login_at" property="lastLoginAt"/>
        <result column="last_login_ip" property="lastLoginIp"/>
        <result column="login_count" property="loginCount"/>
        <result column="failed_login_count" property="failedLoginCount"/>
        <result column="locked_until" property="lockedUntil"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 管理员详细信息映射 -->
    <resultMap id="AdminDetailMap" type="com.xystapp.entity.Admin" extends="BaseResultMap">
        <collection property="permissions" ofType="string" javaType="java.util.List">
            <result column="permission_name"/>
        </collection>
        <collection property="roles" ofType="string" javaType="java.util.List">
            <result column="role_name"/>
        </collection>
    </resultMap>

    <!-- 根据用户名查询管理员 -->
    <select id="selectByUsername" resultMap="BaseResultMap">
        SELECT * FROM admins 
        WHERE username = #{username}
    </select>

    <!-- 根据邮箱查询管理员 -->
    <select id="selectByEmail" resultMap="BaseResultMap">
        SELECT * FROM admins 
        WHERE email = #{email}
    </select>

    <!-- 获取管理员角色列表 -->
    <select id="selectAdminRoles" resultType="string">
        SELECT r.name 
        FROM roles r
        INNER JOIN admin_roles ar ON r.id = ar.role_id
        WHERE ar.admin_id = #{adminId}
    </select>

    <!-- 获取管理员权限列表 -->
    <select id="selectAdminPermissions" resultType="string">
        SELECT DISTINCT p.name
        FROM permissions p
        INNER JOIN role_permissions rp ON p.id = rp.permission_id
        INNER JOIN admin_roles ar ON rp.role_id = ar.role_id
        WHERE ar.admin_id = #{adminId}
    </select>

    <!-- 分页查询管理员列表（包含角色信息） -->
    <select id="selectAdminListWithRoles" resultMap="AdminDetailMap">
        SELECT 
            a.*,
            r.name as role_name,
            p.name as permission_name
        FROM admins a
        LEFT JOIN admin_roles ar ON a.id = ar.admin_id
        LEFT JOIN roles r ON ar.role_id = r.id
        LEFT JOIN role_permissions rp ON r.id = rp.role_id
        LEFT JOIN permissions p ON rp.permission_id = p.id
        <where>
            <if test="status != null and status != ''">
                AND a.status = #{status}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (a.username LIKE CONCAT('%', #{keyword}, '%') 
                     OR a.real_name LIKE CONCAT('%', #{keyword}, '%')
                     OR a.email LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY a.created_at DESC
    </select>

    <!-- 获取管理员详细信息 -->
    <select id="selectAdminDetailById" resultMap="AdminDetailMap">
        SELECT 
            a.*,
            r.name as role_name,
            p.name as permission_name
        FROM admins a
        LEFT JOIN admin_roles ar ON a.id = ar.admin_id
        LEFT JOIN roles r ON ar.role_id = r.id
        LEFT JOIN role_permissions rp ON r.id = rp.role_id
        LEFT JOIN permissions p ON rp.permission_id = p.id
        WHERE a.id = #{adminId}
    </select>

    <!-- 统计管理员数量 -->
    <select id="countAdminsByStatus" resultType="integer">
        SELECT COUNT(*) 
        FROM admins 
        <where>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
    </select>

    <!-- 获取最近登录的管理员列表 -->
    <select id="selectRecentLogins" resultMap="BaseResultMap">
        SELECT * FROM admins 
        WHERE last_login_at IS NOT NULL
        AND last_login_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        ORDER BY last_login_at DESC
        LIMIT #{limit}
    </select>

    <!-- 获取登录次数统计 -->
    <select id="selectLoginStats" resultType="com.xystapp.mapper.AdminMapper$AdminLoginStats">
        SELECT 
            DATE(last_login_at) as date,
            COUNT(*) as loginCount,
            COUNT(DISTINCT id) as uniqueAdmins
        FROM admins 
        WHERE last_login_at BETWEEN #{startDate} AND #{endDate}
        GROUP BY DATE(last_login_at)
        ORDER BY date DESC
    </select>

    <!-- 更新管理员登录信息 -->
    <update id="updateLoginInfo">
        UPDATE admins 
        SET 
            last_login_at = NOW(),
            last_login_ip = #{ip},
            login_count = login_count + 1,
            failed_login_count = 0
        WHERE id = #{adminId}
    </update>

    <!-- 批量更新管理员状态 -->
    <update id="batchUpdateStatus">
        UPDATE admins 
        SET status = #{status},
            updated_at = NOW()
        WHERE id IN
        <foreach collection="adminIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 检查用户名是否存在 -->
    <select id="checkUsernameExists" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM admins 
        WHERE username = #{username}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 检查邮箱是否存在 -->
    <select id="checkEmailExists" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM admins 
        WHERE email = #{email}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

</mapper>
