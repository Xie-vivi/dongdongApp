<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xystapp.mapper.SystemConfigMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.xystapp.entity.SystemConfig">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="config_key" property="configKey" jdbcType="VARCHAR"/>
        <result column="config_value" property="configValue" jdbcType="VARCHAR"/>
        <result column="config_type" property="configType" jdbcType="VARCHAR"/>
        <result column="description" property="description" jdbcType="VARCHAR"/>
        <result column="is_enabled" property="isEnabled" jdbcType="BOOLEAN"/>
        <result column="is_system" property="isSystem" jdbcType="BOOLEAN"/>
        <result column="created_by" property="createdBy" jdbcType="BIGINT"/>
        <result column="updated_by" property="updatedBy" jdbcType="BIGINT"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 基础列定义 -->
    <sql id="Base_Column_List">
        id, config_key, config_value, config_type, description, is_enabled, is_system,
        created_by, updated_by, created_at, updated_at
    </sql>

    <!-- 根据配置键获取配置 -->
    <select id="selectByConfigKey" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM system_configs
        WHERE config_key = #{configKey}
    </select>

    <!-- 分页查询系统配置 -->
    <select id="selectConfigsWithPagination" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM system_configs
        <where>
            <if test="configKey != null and configKey != ''">
                AND config_key LIKE CONCAT('%', #{configKey}, '%')
            </if>
            <if test="configType != null and configType != ''">
                AND config_type = #{configType}
            </if>
        </where>
        ORDER BY is_system DESC, config_type ASC, config_key ASC
    </select>

    <!-- 获取指定类型的配置列表 -->
    <select id="selectConfigsByType" parameterType="java.lang.String" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM system_configs
        WHERE config_type = #{configType}
        ORDER BY is_system DESC, config_key ASC
    </select>

    <!-- 获取启用的配置列表 -->
    <select id="selectEnabledConfigs" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM system_configs
        WHERE is_enabled = true
        ORDER BY config_type ASC, config_key ASC
    </select>

    <!-- 获取系统配置列表 -->
    <select id="selectSystemConfigs" resultMap="BaseResultMap">
        SELECT 
        <include refid="Base_Column_List"/>
        FROM system_configs
        WHERE is_system = true
        ORDER BY config_type ASC, config_key ASC
    </select>

    <!-- 批量更新配置状态 -->
    <update id="batchUpdateStatus">
        UPDATE system_configs
        SET is_enabled = #{isEnabled},
            updated_at = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 检查配置键是否存在 -->
    <select id="existsByConfigKey" resultType="java.lang.Boolean">
        SELECT COUNT(1) > 0
        FROM system_configs
        WHERE config_key = #{configKey}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
    </select>

    <!-- 获取配置数量统计 -->
    <select id="countByType" parameterType="java.lang.String" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM system_configs
        WHERE config_type = #{configType}
    </select>

    <!-- 获取启用的配置数量 -->
    <select id="countEnabledConfigs" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM system_configs
        WHERE is_enabled = true
    </select>

    <!-- 获取系统配置数量 -->
    <select id="countSystemConfigs" resultType="java.lang.Long">
        SELECT COUNT(1)
        FROM system_configs
        WHERE is_system = true
    </select>

</mapper>
