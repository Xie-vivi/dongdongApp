<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xystapp.mapper.CommentMapper">

    <!-- 评论结果映射（包含用户信息） -->
    <resultMap id="CommentWithUserInfoMap" type="com.xystapp.entity.Comment">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="post_id" property="postId"/>
        <result column="content" property="content"/>
        <result column="at_user_id" property="atUserId"/>
        <result column="reply_to_id" property="replyToId"/>
        <result column="created_at" property="createdAt"/>
        
        <!-- 用户信息 -->
        <result column="username" property="username"/>
        <result column="nickname" property="nickname"/>
        <result column="avatar" property="avatar"/>
        
        <!-- 帖子信息 -->
        <result column="post_title" property="postTitle"/>
        
        <!-- @用户信息 -->
        <result column="at_username" property="atUsername"/>
        <result column="at_nickname" property="atNickname"/>
        
        <!-- 回复评论信息 -->
        <result column="reply_to_username" property="replyToUsername"/>
        <result column="reply_to_content" property="replyToContent"/>
    </resultMap>

    <!-- 获取评论详情（包含用户信息） -->
    <select id="selectCommentWithUserInfo" resultMap="CommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.post_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            p.title as post_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN posts p ON c.post_id = p.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.id = #{commentId}
    </select>

    <!-- 获取帖子评论列表（包含用户信息） -->
    <select id="selectPostCommentsWithUserInfo" resultMap="CommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.post_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            p.title as post_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN posts p ON c.post_id = p.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.post_id = #{postId} AND c.reply_to_id IS NULL
        ORDER BY c.created_at DESC
    </select>

    <!-- 根据查询条件获取评论列表（包含用户信息） -->
    <select id="selectCommentsWithQuery" resultMap="CommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.post_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            p.title as post_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN posts p ON c.post_id = p.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        <where>
            <if test="query.postId != null">
                AND c.post_id = #{query.postId}
            </if>
            <if test="query.userId != null">
                AND c.user_id = #{query.userId}
            </if>
            <if test="query.atUserId != null">
                AND c.at_user_id = #{query.atUserId}
            </if>
            <if test="query.replyToId != null">
                AND c.reply_to_id = #{query.replyToId}
            </if>
            <if test="query.keyword != null and query.keyword != ''">
                AND (c.content LIKE CONCAT('%', #{query.keyword}, '%')
                     OR u.username LIKE CONCAT('%', #{query.keyword}, '%')
                     OR u.nickname LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
        </where>
        <choose>
            <when test="query.sortBy == 'created_at' and query.sortOrder == 'asc'">
                ORDER BY c.created_at ASC
            </when>
            <when test="query.sortBy == 'created_at' and query.sortOrder == 'desc'">
                ORDER BY c.created_at DESC
            </when>
            <otherwise>
                ORDER BY c.created_at DESC
            </otherwise>
        </choose>
    </select>

    <!-- 获取回复评论列表（包含用户信息） -->
    <select id="selectReplyCommentsWithUserInfo" resultMap="CommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.post_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            p.title as post_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN posts p ON c.post_id = p.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.reply_to_id = #{parentCommentId}
        ORDER BY c.created_at ASC
    </select>

    <!-- 获取用户评论列表（包含用户信息和帖子信息） -->
    <select id="selectUserCommentsWithUserInfo" resultMap="CommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.post_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            p.title as post_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN posts p ON c.post_id = p.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.user_id = #{userId}
        ORDER BY c.created_at DESC
    </select>

    <!-- 获取@用户评论列表（包含用户信息） -->
    <select id="selectAtUserCommentsWithUserInfo" resultMap="CommentWithUserInfoMap">
        SELECT 
            c.id, c.user_id, c.post_id, c.content, c.at_user_id, c.reply_to_id, c.created_at,
            u.username, u.nickname, u.avatar,
            p.title as post_title,
            u_at.username as at_username,
            u_at.nickname as at_nickname,
            u_reply.username as reply_to_username,
            c_reply.content as reply_to_content
        FROM comments c
        INNER JOIN users u ON c.user_id = u.id
        INNER JOIN posts p ON c.post_id = p.id
        LEFT JOIN users u_at ON c.at_user_id = u_at.id
        LEFT JOIN comments c_reply ON c.reply_to_id = c_reply.id
        LEFT JOIN users u_reply ON c_reply.user_id = u_reply.id
        WHERE c.at_user_id = #{atUserId}
        ORDER BY c.created_at DESC
    </select>

    <!-- 删除评论及其所有回复（使用存储过程方式，兼容MySQL 5.7+） -->
    <delete id="deleteCommentAndReplies">
        DELETE FROM comments 
        WHERE id = #{commentId}
           OR reply_to_id = #{commentId}
           OR reply_to_id IN (
               SELECT id FROM (
                   SELECT c2.id 
                   FROM comments c1
                   INNER JOIN comments c2 ON c2.reply_to_id = c1.id
                   WHERE c1.id = #{commentId}
                   UNION
                   SELECT c3.id
                   FROM comments c1
                   INNER JOIN comments c2 ON c2.reply_to_id = c1.id
                   INNER JOIN comments c3 ON c3.reply_to_id = c2.id
                   WHERE c1.id = #{commentId}
                   UNION
                   SELECT c4.id
                   FROM comments c1
                   INNER JOIN comments c2 ON c2.reply_to_id = c1.id
                   INNER JOIN comments c3 ON c3.reply_to_id = c2.id
                   INNER JOIN comments c4 ON c4.reply_to_id = c3.id
                   WHERE c1.id = #{commentId}
               ) AS nested_comments
           )
    </delete>

    <!-- 删除帖子的所有评论 -->
    <delete id="deleteCommentsByPostId">
        DELETE FROM comments WHERE post_id = #{postId}
    </delete>

    <!-- 检查用户是否存在 -->
    <select id="userExists" resultType="boolean">
        SELECT COUNT(1) > 0 FROM users WHERE id = #{userId}
    </select>

    <!-- 检查用户是否是评论作者 -->
    <select id="isCommentAuthor" resultType="boolean">
        SELECT COUNT(1) > 0 
        FROM comments 
        WHERE id = #{commentId} AND user_id = #{userId}
    </select>

    <!-- 获取回复深度（兼容MySQL 5.7+） -->
    <select id="getReplyDepth" resultType="integer">
        SELECT CASE 
            WHEN c1.reply_to_id IS NULL THEN 0
            WHEN c2.reply_to_id IS NULL THEN 1
            WHEN c3.reply_to_id IS NULL THEN 2
            WHEN c4.reply_to_id IS NULL THEN 3
            ELSE 4
        END as depth
        FROM comments c1
        LEFT JOIN comments c2 ON c1.reply_to_id = c2.id
        LEFT JOIN comments c3 ON c2.reply_to_id = c3.id
        LEFT JOIN comments c4 ON c3.reply_to_id = c4.id
        WHERE c1.id = #{commentId}
    </select>

    <!-- 获取评论回复数量（兼容MySQL 5.7+） -->
    <select id="getReplyCount" resultType="integer">
        SELECT (
            SELECT COUNT(1) FROM comments WHERE reply_to_id = #{commentId}
        ) + (
            SELECT COUNT(1) 
            FROM comments c1
            INNER JOIN comments c2 ON c1.reply_to_id = c2.id
            WHERE c2.reply_to_id = #{commentId}
        ) + (
            SELECT COUNT(1) 
            FROM comments c1
            INNER JOIN comments c2 ON c1.reply_to_id = c2.id
            INNER JOIN comments c3 ON c2.reply_to_id = c3.id
            WHERE c3.reply_to_id = #{commentId}
        ) + (
            SELECT COUNT(1) 
            FROM comments c1
            INNER JOIN comments c2 ON c1.reply_to_id = c2.id
            INNER JOIN comments c3 ON c2.reply_to_id = c3.id
            INNER JOIN comments c4 ON c3.reply_to_id = c4.id
            WHERE c4.reply_to_id = #{commentId}
        ) as total_count
    </select>

    <!-- 统计帖子评论数量 -->
    <select id="countCommentsByPostId" resultType="long">
        SELECT COUNT(1) FROM comments WHERE post_id = #{postId}
    </select>

    <!-- 统计帖子今日评论数量 -->
    <select id="countTodayCommentsByPostId" resultType="long">
        SELECT COUNT(1) 
        FROM comments 
        WHERE post_id = #{postId} 
        AND DATE(created_at) = CURDATE()
    </select>

    <!-- 统计帖子回复评论数量 -->
    <select id="countReplyCommentsByPostId" resultType="long">
        SELECT COUNT(1) 
        FROM comments 
        WHERE post_id = #{postId} 
        AND reply_to_id IS NOT NULL
    </select>

    <!-- 获取评论路径（用于计算回复深度） -->
    <select id="getCommentPath" resultType="long">
        WITH RECURSIVE comment_path AS (
            SELECT id, reply_to_id
            FROM comments 
            WHERE id = #{commentId}
            UNION ALL
            SELECT c.id, c.reply_to_id
            FROM comments c
            INNER JOIN comment_path cp ON c.id = cp.reply_to_id
            WHERE cp.reply_to_id IS NOT NULL
        )
        SELECT id FROM comment_path ORDER BY id
    </select>

    <!-- ==================== 管理员功能相关方法 ==================== -->

    <!-- 按时间范围统计评论数量 -->
    <select id="countCommentsByTimeRange" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM comments
        WHERE 1=1
        <choose>
            <when test="timeRange == 'today'">
                AND DATE(created_at) = CURDATE()
            </when>
            <when test="timeRange == 'yesterday'">
                AND DATE(created_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)
            </when>
            <when test="timeRange == 'week'">
                AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
            </when>
            <when test="timeRange == 'month'">
                AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            </when>
            <when test="timeRange == 'year'">
                AND created_at >= DATE_SUB(NOW(), INTERVAL 365 DAY)
            </when>
        </choose>
    </select>

</mapper>
